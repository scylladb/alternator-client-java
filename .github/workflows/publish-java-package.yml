name: Release Java Package to Maven Central

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version (e.g. "1.0.5")'
        required: true
        type: string
      dry-run:
        description: 'Dry run: build and verify without publishing'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip tests during release'
        required: false
        type: boolean
        default: false
      create-tag:
        description: 'Create and push git tag'
        required: false
        type: boolean
        default: true

env:
  IS_CICD: 1

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}

    steps:
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.releaseVersion }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Error: Version '$VERSION' does not match expected format (e.g., 1.0.5 or 1.0.5-SNAPSHOT)"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Version format validated: $VERSION"

  release:
    name: Release to Maven Central
    runs-on: ubuntu-latest
    needs: [validate]
    timeout-minutes: 30

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_CENTRAL_TOKEN
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Set release version
        run: |
          echo "Setting version to ${{ needs.validate.outputs.version }}"
          mvn versions:set -DnewVersion=${{ needs.validate.outputs.version }} -DgenerateBackupPoms=false

      - name: Verify build
        run: |
          mvn clean verify -Prelease ${{ inputs.skip-tests && '-DskipTests' || '' }}

      - name: Deploy to Maven Central (dry-run)
        if: inputs.dry-run == true
        run: |
          echo "üß™ DRY RUN: Skipping actual deployment"
          mvn clean deploy -Prelease -DskipRemoteStaging=true ${{ inputs.skip-tests && '-DskipTests' || '' }}
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: Deploy to Maven Central
        if: inputs.dry-run == false
        run: |
          echo "üöÄ Publishing to Maven Central..."
          mvn clean deploy -Prelease ${{ inputs.skip-tests && '-DskipTests' || '' }}
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: Create git tag
        if: inputs.dry-run == false && inputs.create-tag == true
        run: |
          TAG="java-v${{ needs.validate.outputs.version }}"
          echo "Creating tag: $TAG"
          git tag -a "$TAG" -m "Release Java package version ${{ needs.validate.outputs.version }}"
          git push origin "$TAG"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: release-artifacts
          path: |
            target/*.jar
            target/*.pom
          retention-days: 30

      - name: Create GitHub Release
        if: inputs.dry-run == false && inputs.create-tag == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: java-v${{ needs.validate.outputs.version }}
          name: Java Load Balancing v${{ needs.validate.outputs.version }}
          body: |
            ## Java Load Balancing Library v${{ needs.validate.outputs.version }}

            ### Maven Coordinates
            ```xml
            <dependency>
                <groupId>com.scylladb.alternator</groupId>
                <artifactId>load-balancing</artifactId>
                <version>${{ needs.validate.outputs.version }}</version>
            </dependency>
            ```

            ### Installation
            Available on [Maven Central](https://central.sonatype.com/artifact/com.scylladb.alternator/load-balancing/${{ needs.validate.outputs.version }})
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          files: |
            target/load-balancing-${{ needs.validate.outputs.version }}.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release Status
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: always()

    steps:
      - name: Release Summary
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            if [ "${{ inputs.dry-run }}" == "true" ]; then
              echo "‚úÖ Dry run completed successfully for version ${{ needs.validate.outputs.version }}"
            else
              echo "üéâ Successfully released version ${{ needs.validate.outputs.version }} to Maven Central!"
              echo ""
              echo "Maven coordinates:"
              echo "  groupId: com.scylladb.alternator"
              echo "  artifactId: load-balancing"
              echo "  version: ${{ needs.validate.outputs.version }}"
            fi
          else
            echo "‚ùå Release failed for version ${{ needs.validate.outputs.version }}"
            exit 1
          fi
